<template name="detailContent">
  <view class="device-detail" wx:if="{{device}}">
    <view class="refresh-tip" wx:if="{{isRefreshing}}">正在刷新...</view>
    <!-- 设备信息卡片 -->
    <view class="device-card">
      <view class="device-header">
        <view class="device-name">{{device.name || '未命名设备'}}</view>
        <view class="edit-icon" wx:if="{{!isReadOnly}}" bindtap="onEditDevice">
          <image src="/assets/icons/edit.svg" mode="aspectFit" class="edit-image" />
        </view>
      </view>
      <view class="device-status">
        <view class="status-dot {{device.activeAlarmCount > 0 ? 'status-alarm' : 'status-normal'}}"></view>
        <text class="status-text">当前警报数 {{device.activeAlarmCount}}</text>
      </view>
      <view class="device-location">设备位置：{{device.location || '未设置'}}</view>
    </view>

    <!-- 分享按钮 -->
    <view wx:if="{{!isReadOnly}}">
      <button class="share-btn" wx:if="{{canShare}}" open-type="share" bindtap="onPrepareShare">
        <image src="/assets/icons/share.svg" mode="aspectFit" class="share-icon" />
        <text>分享给家人</text>
      </button>
      <button class="share-btn" wx:else bindtap="onShareToFamily">
        <image src="/assets/icons/share.svg" mode="aspectFit" class="share-icon" />
        <text>分享给家人</text>
      </button>
    </view>

    <view class="share-notice" wx:if="{{shareNotice}}">
      <text>{{shareNotice}}</text>
    </view>

    <!-- 紧急呼叫按钮 -->
    <view class="alarm-buttons-section">
      <view class="section-title">紧急呼叫按钮</view>
      <view class="alarm-buttons">
        <view class="alarm-button-card" wx:for="{{device.buttons}}" wx:key="id">
          <view class="alarm-button-header">
            <view class="alarm-button-name">按钮 {{index + 1}}</view>
            <view class="alarm-count">警报数 {{item.alarmsCount}}</view>
          </view>
          <view class="alarm-row">
            <view class="alarm-label">位置</view>
            <view class="alarm-value">{{item.location || '未设置'}}</view>
          </view>
          <view class="alarm-row">
            <view class="alarm-label">注释</view>
            <view class="alarm-value">{{item.note || '未设置'}}</view>
          </view>
          <view class="alarm-actions" wx:if="{{!isReadOnly}}">
            <button class="alarm-action-btn edit-btn" bindtap="onAlarmEdit" data-id="{{item.id}}">编辑</button>
            <button class="alarm-action-btn delete-btn" bindtap="onAlarmDelete" data-id="{{item.id}}">删除</button>
          </view>
        </view>
        <view class="alarm-empty" wx:if="{{!device.buttons || device.buttons.length === 0}}">
          <text>暂无按钮</text>
        </view>
      </view>
    </view>

    <!-- 已分享用户 -->
    <view class="shared-users-section" wx:if="{{!isReadOnly}}">
      <view class="section-title">已分享用户</view>
      <view class="user-list">
        <view class="user-item" wx:for="{{device.sharedTo}}" wx:key="id">
          <view class="user-avatar">{{item.name ? item.name[0] : '?'}}</view>
          <view class="user-name">{{item.name || '未命名'}}</view>
          <view class="remove-btn" bindtap="onRemoveUser" data-id="{{item.id}}">×</view>
        </view>
      </view>
    </view>

    <!-- 删除设备 -->
    <view class="delete-section" wx:if="{{!isReadOnly}}">
      <view class="delete-btn" bindtap="onDeleteDevice">删除设备</view>
      <view class="delete-hint">删除后该设备将无法再触发你的通知</view>
    </view>
  </view>

  <view class="empty-state" wx:else>
    <text class="empty-text">未找到设备信息</text>
  </view>
</template>

<view class="page-container">
  <scroll-view
    class="detail-scroll"
    scroll-y="{{detailScrollReady ? detailScrollable : true}}"
    show-scrollbar="{{detailScrollable}}"
    refresher-enabled="{{true}}"
    refresher-triggered="{{isRefreshing}}"
    refresher-background="#f5f5f5"
    bindrefresherrefresh="onScrollRefresh"
  >
    <template
      is="detailContent"
      data="{{device: device, shareNotice: shareNotice, canShare: canShare, isRefreshing: isRefreshing, isReadOnly: isReadOnly}}"
    />
  </scroll-view>

  <view class="modal-overlay" wx:if="{{showEditModal}}" bindtap="onEditModalClose"></view>
  <view class="modal-container" wx:if="{{showEditModal}}">
    <view class="modal-title">编辑设备</view>

    <view class="modal-field">
      <view class="field-label">设备名称</view>
      <input class="field-input" placeholder="请输入设备名称" value="{{editingDevice.name}}" bindinput="onEditNameInput" />
    </view>

    <view class="modal-field">
      <view class="field-label">设备位置</view>
      <input class="field-input" placeholder="请输入设备位置" value="{{editingDevice.location}}" bindinput="onEditLocationInput" />
    </view>

    <view class="modal-buttons">
      <button class="modal-btn cancel-btn" bindtap="onEditModalClose">取消</button>
      <button class="modal-btn confirm-btn" bindtap="onEditModalConfirm">更新</button>
    </view>
  </view>

  <view class="modal-overlay" wx:if="{{showButtonModal}}" bindtap="onButtonModalClose"></view>
  <view class="modal-container" wx:if="{{showButtonModal}}">
    <view class="modal-title">编辑按钮</view>

    <view class="modal-field">
      <view class="field-label">位置</view>
      <input class="field-input" placeholder="请输入位置" value="{{editingButton.location}}" bindinput="onButtonLocationInput" />
    </view>

    <view class="modal-field">
      <view class="field-label">注释</view>
      <input class="field-input" placeholder="请输入注释" value="{{editingButton.note}}" bindinput="onButtonNoteInput" />
    </view>

    <view class="modal-buttons">
      <button class="modal-btn cancel-btn" bindtap="onButtonModalClose">取消</button>
      <button class="modal-btn confirm-btn" bindtap="onButtonModalConfirm">更新</button>
    </view>
  </view>
</view>
