<template name="deviceContent">
  <view class="page-content">
    <view class="refresh-tip" wx:if="{{isRefreshing}}">正在刷新...</view>
    <view class="subscribe-banner" wx:if="{{showSubscribeButton}}">
      <view class="subscribe-text">请点击授权，否则可能收不到通知</view>
      <button
        class="subscribe-btn"
        bindtap="onSubscribeButtonTap"
        loading="{{isIncrementingQuota}}"
        disabled="{{isIncrementingQuota}}"
      >
        去授权
      </button>
    </view>
    <!-- 设备列表 -->
    <view class="device-list-section">
      <view class="section-title">设备列表</view>

      <view class="loading-text" wx:if="{{isLoading}}">正在加载设备...</view>
      <view class="error-text" wx:elif="{{loadError}}">{{loadError}}</view>

      <view class="device-list" wx:else>
        <view class="device-item" wx:for="{{devices}}" wx:key="id" bindtap="onDeviceTap" data-index="{{index}}">
          <view class="device-item-header">
            <view class="device-item-name">{{item.name || '未命名设备'}}</view>
            <view class="device-item-status">
              <view class="status-dot {{item.activeAlarmCount > 0 ? 'status-alarm' : 'status-normal'}}"></view>
              <text class="status-text">当前警报数 {{item.activeAlarmCount}}</text>
            </view>
          </view>
        </view>

        <view class="empty-text" wx:if="{{!devices.length}}">暂无设备</view>
      </view>
    </view>

    <!-- 设备配置视图（点击添加按钮后显示） -->
    <view class="config-overlay {{configClosing ? 'is-closing' : ''}}" wx:if="{{showConfig}}">
      <view class="config-panel {{configClosing ? 'is-closing' : ''}}">
        <view class="config-header">
          <view class="form-title">设备配置</view>
          <button class="collapse-btn" bindtap="onHideConfig">
            <view class="collapse-icon"></view>
          </button>
        </view>
        <view class="form-desc">输入 WiFi 信息以配置设备</view>
        <view class="form-desc-compact">请确保蓝牙已打开</view>

        <view class="config-form" wx:if="{{configStep === 'idle' || configStep === 'error'}}">
          <view class="input-group">
            <view class="input-label">WiFi 名称</view>
            <input
              class="input-field"
              placeholder="请输入 WiFi 名称"
              value="{{ssid}}"
              bindinput="onSsidInput"
            />
          </view>

          <view class="input-group">
            <view class="input-label">WiFi 密码</view>
            <view class="input-with-action">
              <input
                class="input-field input-field--with-action"
                placeholder="请输入 WiFi 密码"
                password="{{!showPassword}}"
                value="{{password}}"
                bindinput="onPasswordInput"
              />
              <view class="reveal-btn" bindtap="onTogglePassword">
                {{showPassword ? '隐藏' : '显示'}}
              </view>
            </view>
          </view>

          <view class="error-text" wx:if="{{configStep === 'error'}}">{{statusText}}</view>
          <button class="start-btn" bindtap="onStartConfig">开始配置</button>
        </view>

        <!-- 配置进行中 -->
        <view class="progress-state" wx:elif="{{configStep !== 'done'}}">
          <view class="loading-container">
            <view class="loading-spinner"></view>
          </view>
          <view class="progress-status">{{statusText}}</view>
          <button class="cancel-btn" bindtap="onReset">取消</button>
        </view>

        <!-- 配置完成 -->
        <view class="done-state" wx:else>
          <view class="done-icon">
            <view class="checkmark"></view>
          </view>
          <view class="done-title">配置完成</view>
          <button class="reset-btn" bindtap="onHideConfig">关闭</button>
        </view>
      </view>
    </view>
  </view>
</template>

<view class="page-container">
  <scroll-view
    class="page-scroll"
    scroll-y="{{pageScrollReady ? pageScrollable : true}}"
    show-scrollbar="{{pageScrollable}}"
    refresher-enabled="{{true}}"
    refresher-triggered="{{isRefreshing}}"
    refresher-background="#f5f5f5"
    bindrefresherrefresh="onScrollRefresh"
  >
    <template
      is="deviceContent"
      data="{{devices: devices, isLoading: isLoading, loadError: loadError, showConfig: showConfig, configStep: configStep, ssid: ssid, password: password, showPassword: showPassword, statusText: statusText, resultMessage: resultMessage, isRefreshing: isRefreshing, showSubscribeButton: showSubscribeButton, isIncrementingQuota: isIncrementingQuota}}"
    />
  </scroll-view>

  <view class="page-footer" wx:if="{{!showConfig}}">
    <button class="add-device-btn" bindtap="onShowConfig">添加设备</button>
  </view>
</view>
